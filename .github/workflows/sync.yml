name: Sync to Child Repos

on:
  push:
    tags:
      - 'sync-*'

jobs:
  sync-sites:
    runs-on: ubuntu-latest

    env:
      CHILD_REPOS: |
        site-one=https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/Funnel-Platform/bitcoin-matrix-vip.git

    steps:
      - name: Checkout master repo
        uses: actions/checkout@v4

      - name: Install Git
        run: sudo apt-get install -y git

      - name: Sync to child repos
        run: |
          set -e

          for ENTRY in $CHILD_REPOS; do
            NAME=$(echo $ENTRY | cut -d= -f1)
            REPO_URL=$(echo $ENTRY | cut -d= -f2-)

            echo "üîÅ Syncing to $NAME..."

            rm -rf /tmp/$NAME
            git clone --depth=1 $REPO_URL /tmp/$NAME

            cd /tmp/$NAME

            # If no .git/HEAD or no refs, repo is empty
            if [ ! -f .git/HEAD ] || [ -z "$(git rev-parse --branches)" ]; then
              echo "‚ö†Ô∏è Repo is empty. Creating orphan main branch..."
              git checkout --orphan main
            else
              echo "‚úÖ Repo has content."
              git fetch origin
              git checkout main || git checkout -b main
            fi

            # Remove all files except .git
            find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

            # Copy in all files from master repo
            cp -r $GITHUB_WORKSPACE/* .
            cp -r $GITHUB_WORKSPACE/.* . 2>/dev/null || true

            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"

            git add .

            # Commit only if there are changes (forces a commit if orphan)
            if git diff --cached --quiet; then
              echo "‚ö†Ô∏è Nothing to commit"
            else
              git commit -m "üîÑ Initial sync from master repo - $(date +'%Y-%m-%d %H:%M:%S')"
            fi

            # Push the main branch (even if it's the first commit ever)
            git push --set-upstream origin main
          done